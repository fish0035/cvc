<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>飛行貓咪遊戲</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: none;
        }
        #gameCanvas {
            display: block;
        }
        #preload-images {
            display: none;
        }
    </style>
</head>
<body>
    <div id="preload-images">
        <img id="catImage" src="https://imgur.com/a/J4517Ts.png" alt="Flying Cat">
        <img id="grassImage" src="https://imgur.com/a/6vISDin.png" alt="Grass Background">
    </div>
    <canvas id="gameCanvas"></canvas>
    <script>
        // 遊戲狀態
        const GAME_STATE = {
            START: 0,
            PLAYING: 1,
            GAME_OVER: 2,
            LEVEL_COMPLETE: 3
        };

        // 遊戲設置
        const GAME_CONFIG = {
            CAT_WIDTH: 50,
            CAT_HEIGHT: 30,
            OBSTACLE_WIDTH: 50,
            OBSTACLE_GAP: 200,
            OBSTACLE_SPEED: 2,
            GRAVITY: 0.25,
            FLAP_STRENGTH: -4.6,
            MAX_LEVEL: 5
        };

        // 遊戲變量
        let canvas, ctx;
        let cat, obstacles;
        let score, gameState, currentLevel, gameTime;
        let catImage, grassImage;

        // 初始化遊戲
        function init() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            // 設置canvas為全屏
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // 初始化遊戲狀態
            gameState = GAME_STATE.START;
            currentLevel = 1;
            
            // 加載圖片
            catImage = document.getElementById('catImage');
            grassImage = document.getElementById('grassImage');
            
            // 事件監聽器
            canvas.addEventListener('click', handleClick);
            canvas.addEventListener('touchstart', handleTouch);
            
            // 開始遊戲循環
            gameLoop();
        }

        // 調整canvas大小
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        // 處理點擊事件
        function handleClick(event) {
            event.preventDefault();
            handleInteraction();
        }

        // 處理觸摸事件
        function handleTouch(event) {
            event.preventDefault();
            handleInteraction();
        }

        // 處理交互
        function handleInteraction() {
            switch(gameState) {
                case GAME_STATE.START:
                    startGame();
                    break;
                case GAME_STATE.PLAYING:
                    if (cat) cat.flap();
                    break;
                case GAME_STATE.GAME_OVER:
                case GAME_STATE.LEVEL_COMPLETE:
                    resetGame();
                    break;
            }
        }

        // 開始新遊戲
        function startGame() {
            gameState = GAME_STATE.PLAYING;
            score = 50;
            gameTime = 0;
            cat = new Cat();
            obstacles = [];
            spawnObstacle();
        }

        // 重置遊戲
        function resetGame() {
            currentLevel = 1;
            startGame();
        }

        // 遊戲主循環
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // 更新遊戲狀態
        function update() {
            if (gameState !== GAME_STATE.PLAYING) return;
            
            gameTime++;
            cat.update();
            updateObstacles();
            checkCollisions();
            
            if (score >= 100) {
                levelComplete();
            } else if (gameTime >= 60 * 60) { // 60 FPS * 60 seconds
                gameOver();
            }
        }

        // 繪製遊戲
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            switch(gameState) {
                case GAME_STATE.START:
                    drawStartScreen();
                    break;
                case GAME_STATE.PLAYING:
                    drawGameScreen();
                    break;
                case GAME_STATE.GAME_OVER:
                    drawGameOverScreen();
                    break;
                case GAME_STATE.LEVEL_COMPLETE:
                    drawLevelCompleteScreen();
                    break;
            }
        }

        // 貓咪類
        class Cat {
            constructor() {
                this.x = canvas.width / 4;
                this.y = canvas.height / 2;
                this.velocity = 0;
            }
            
            update() {
                this.velocity += GAME_CONFIG.GRAVITY;
                this.y += this.velocity;
                
                if (this.y < 0) this.y = 0;
                if (this.y > canvas.height - GAME_CONFIG.CAT_HEIGHT) {
                    this.y = canvas.height - GAME_CONFIG.CAT_HEIGHT;
                    this.velocity = 0;
                }
            }
            
            flap() {
                this.velocity = GAME_CONFIG.FLAP_STRENGTH;
            }
            
            draw() {
                if (catImage.complete) {
                    ctx.drawImage(catImage, this.x, this.y, GAME_CONFIG.CAT_WIDTH, GAME_CONFIG.CAT_HEIGHT);
                } else {
                    ctx.fillStyle = 'orange';
                    ctx.fillRect(this.x, this.y, GAME_CONFIG.CAT_WIDTH, GAME_CONFIG.CAT_HEIGHT);
                }
            }
        }

        // 障礙物類
        class Obstacle {
            constructor() {
                this.x = canvas.width;
                this.topHeight = Math.random() * (canvas.height - GAME_CONFIG.OBSTACLE_GAP);
                this.bottomY = this.topHeight + GAME_CONFIG.OBSTACLE_GAP;
            }
            
            update() {
                this.x -= GAME_CONFIG.OBSTACLE_SPEED * (1 + (currentLevel - 1) * 0.1);
            }
            
            draw() {
                ctx.fillStyle = 'green';
                ctx.fillRect(this.x, 0, GAME_CONFIG.OBSTACLE_WIDTH, this.topHeight);
                ctx.fillRect(this.x, this.bottomY, GAME_CONFIG.OBSTACLE_WIDTH, canvas.height - this.bottomY);
            }
        }

        // 生成新障礙物
        function spawnObstacle() {
            obstacles.push(new Obstacle());
        }

        // 更新所有障礙物
        function updateObstacles() {
            for (let i = obstacles.length - 1; i >= 0; i--) {
                obstacles[i].update();
                
                if (obstacles[i].x + GAME_CONFIG.OBSTACLE_WIDTH < 0) {
                    obstacles.splice(i, 1);
                    score += 5;
                }
            }
            
            if (obstacles.length === 0 || canvas.width - obstacles[obstacles.length - 1].x >= 300) {
                spawnObstacle();
            }
        }

        // 碰撞檢測
        function checkCollisions() {
            for (let obstacle of obstacles) {
                if (
                    cat.x < obstacle.x + GAME_CONFIG.OBSTACLE_WIDTH &&
                    cat.x + GAME_CONFIG.CAT_WIDTH > obstacle.x &&
                    (cat.y < obstacle.topHeight || cat.y + GAME_CONFIG.CAT_HEIGHT > obstacle.bottomY)
                ) {
                    score -= 3;
                    if (score < 0) gameOver();
                }
            }
        }

        // 遊戲結束
        function gameOver() {
            gameState = GAME_STATE.GAME_OVER;
        }

        // 關卡完成
        function levelComplete() {
            if (currentLevel < GAME_CONFIG.MAX_LEVEL) {
                currentLevel++;
                gameState = GAME_STATE.LEVEL_COMPLETE;
            } else {
                // 遊戲通關
                gameState = GAME_STATE.GAME_OVER;
            }
        }

        // 繪製開始畫面
        function drawStartScreen() {
            drawBackground();
            ctx.fillStyle = 'black';
            ctx.font = '30px Arial';
            ctx.fillText('點擊開始遊戲', canvas.width / 2 - 100, canvas.height / 2);
        }

        // 繪製遊戲畫面
        function drawGameScreen() {
            drawBackground();
            for (let obstacle of obstacles) {
                obstacle.draw();
            }
            cat.draw();
            
            ctx.fillStyle = 'black';
            ctx.font = '20px Arial';
            ctx.fillText(`分數: ${score}`, 10, 30);
            ctx.fillText(`關卡: ${currentLevel}`, 10, 60);
            ctx.fillText(`時間: ${Math.floor(gameTime / 60)}`, canvas.width - 100, 30);
        }

        // 繪製遊戲結束畫面
        function drawGameOverScreen() {
            drawBackground();
            ctx.fillStyle = 'black';
            ctx.font = '30px Arial';
            ctx.fillText('遊戲結束', canvas.width / 2 - 70, canvas.height / 2 - 40);
            ctx.fillText('點擊重新開始', canvas.width / 2 - 100, canvas.height / 2 + 40);
        }

        // 繪製關卡完成畫面
        function drawLevelCompleteScreen() {
            drawBackground();
            ctx.fillStyle = 'black';
            ctx.font = '30px Arial';
            ctx.fillText(`恭喜通過第 ${currentLevel - 1} 關`, canvas.width / 2 - 120, canvas.height / 2 - 40);
            ctx.fillText('點擊進入下一關', canvas.width / 2 - 110, canvas.height / 2 + 40);
        }

        // 繪製背景
        function drawBackground() {
            if (grassImage.complete && currentLevel === 1) {
                // 在第一關使用草地背景
                let pattern = ctx.createPattern(grassImage, 'repeat');
                ctx.fillStyle = pattern;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else {
                // 其他關卡使用純色背景
                ctx.fillStyle = getLevelBackground();
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        }

        // 獲取關卡背景
        function getLevelBackground() {
            switch(currentLevel) {
                case 1: return '#90EE90'; // 草地綠（如果圖片加載失敗）
                case 2: return '#D2B48C'; // 圖書館棕
                case 3: return '#87CEEB'; // 飛機場藍
                case 4: return '#FFD700'; // 巴黎金
                case 5: return '#000000'; // 外太空黑
                default: return '#FFFFFF';
            }
        }

        // 初始化遊戲
        init();
    </script>
</body>
</html>